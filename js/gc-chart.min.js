"use strict";Date.prototype.simpleDate=function(){var a=this.getFullYear(),b=this.getMonth()+1,c=this.getDate();return a+"-"+(1===b.toString().length?"0"+b:b)+"-"+(1===c.toString().length?"0"+c:c)},Vue.component("gc-chart",{props:{chartid:{type:String,default:"chart1",required:!0},gcApikey:{type:String,default:"39553fb7-7f6f-4945-9b84-a4c8745bdbec"},gcHost:{type:String,default:"geocledian.com"},gcParcelId:{default:-1},gcParcelIds:{type:String,default:""},products:{type:String,default:"vitality,ndvi,ndwi,ndre1,ndre2,savi,evi2,cire,npcri"},mode:{type:String,default:"one-index"},gcZoomStartdate:{type:String,default:""},gcZoomEnddate:{type:String,default:""},entity:{type:String,default:""},crop:{type:String,default:""},name:{type:String,default:""},initialLoading:{type:String,default:"true"},gcSelectedParcelId:{type:Number,default:-1},gcParcels:{type:Array,default:function(){return[]}},gcSelectedProduct:{type:String,default:""}},template:'<div :id="chartid" class="gc-chart">          \n            <div>\n            <p class="chartOptionsTitle is-size-6 is-orange is-inline-block" style="margin-bottom: 1.0rem; cursor: pointer;" \n                v-on:click="toggleChartOptions">\n               Chart options \n              <i class="fas fa-angle-down fa-sm"></i>\n            </p>\n\n            <div :id="\'chartOptions_\'+chartid" class="chartOptions is-horizontal is-flex is-hidden"\n                  style="max-height: 6.6rem !important;">\n\n            <div class="field">\n              <div class="field-label"><label class="label has-text-left is-grey">Graph type</label></div>\n              <div class="field-body">\n                <div class="select is-small">\n                <select v-model="selectedGraphType">\n                  <option value="line">Lines</option>\n                  <option value="spline">Splines</option>\n                  <option value="area-spline">Area Splines</option>\n                </select>\n                </div>\n              </div>\n            </div>\n\n            <div class="field is-vertical" v-if="mode==\'one-index\'">\n              <div class="field-label"><label class="label has-text-left is-grey">Hide graphs</label></div>\n              <div class="field-body" style="overflow-y: auto; height: 6.4rem;">\n                <div class="control">\n                  <div class="field is-horizontal">\n                    <div class="field-body">\n                      <div class="control">\n                        <label class="label is-grey is-small">\n                          <input class="is-small" :id="\'chkChartHideMean_\'+chartid" type="checkbox" value="mean" v-model="hidden_graphs"> Mean </label>\n                      </div>\n                    </div>\n                  </div>         \n                  <div class="field is-horizontal">\n                    <div class="field-body">\n                      <div class="control">\n                        <label class="label is-small is-grey">\n                          <input class="is-small" :id="\'chkChartHideMin_\'+chartid" type="checkbox" value="min" v-model="hidden_graphs"> Minimum </label>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="field is-horizontal">\n                    <div class="field-body">\n                      <div class="control">\n                        <label class="label is-small is-grey">\n                          <input class="is-small" :id="\'chkChartHideMax_\'+chartid" type="checkbox" value="max" v-model="hidden_graphs"> Maximum </label>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="field is-horizontal">\n                      <div class="field-body">\n                        <div class="control">\n                          <label class="label is-small is-grey">\n                            <input class="is-small" :id="\'chkChartHideStdDev_\'+chartid" type="checkbox" value="std.dev." v-model="hidden_graphs"> Standard deviation</label>\n                        </div>\n                      </div>\n                  </div>\n                  <div class="field is-horizontal">\n                    <div class="field-body">\n                      <div class="control">\n                        <label class="label is-small is-grey">\n                          <input class="is-small" :id="\'chkChartHideMarker_\'+chartid" type="checkbox" value="marker" v-model="hidden_graphs"> Marker</label>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n                </div>\n            </div>\n            <div class="field" v-if="mode==\'one-index\'">\n              <div class="field-label"><label class="label has-text-left is-grey">Marker</label></div>\n              <div class="field-body">\n                <div class="select is-small">\n                  <select v-model="selectedMarkerType">\n                    <option value="phenology">Phenology</option>\n                    <option value="sn_marker">SN Marker</option>\n                  </select>\n              </div>\n            </div>  \n            </div>\n\n            \x3c!-- date filter --\x3e\n            <div class="field is-vertical">\n              <div class="field-label">\n                <label class="label is-grey is-small has-text-left"> Date Zoom</label>\n              </div>\n              <div class="field-body is-horizontal">\n                <div class="control has-icons-left" style="padding-bottom: 10px; max-width: 7.4rem;">\n                  <input :id="\'inpFilterDateFrom_\'+this.chartid" type="text" class="input is-small"\n                    placeholder="[YYYY-MM-DD]" v-model="chartFromDate">\n                  <span class="icon is-small is-left">\n                      <i class="fas fa-clock fa-lg"></i>\n                  </span>\n                </div>\n              </div>\n              <div class="field-body is-horizontal">\n                <div class="control has-icons-left" style="padding-bottom: 10px; max-width: 7.4rem;">\n                  <input :id="\'inpFilterDateTo_\'+this.chartid" type="text" class="input is-small"\n                        placeholder="[YYYY-MM-DD]"  v-model="chartToDate">\n                  <span class="icon is-small is-left">\n                      <i class="fas fa-clock fa-lg"></i>\n                  </span>\n                </div>\n              </div>  \n            </div>\n          </div>\n          </div>\x3c!-- chart settings --\x3e\n\n          <div :id="\'chartNotice_\'+chartid" class="content is-hidden"></div>\n\n          <div :id="\'chartSpinner_\'+chartid" class="chartSpinner spinner is-hidden">\n            <div class="rect1"></div>\n            <div class="rect2"></div>\n            <div class="rect3"></div>\n            <div class="rect4"></div>\n            <div class="rect5"></div>\n          </div>\n\n          <div style="position: relative;">\n          <div :id="\'chart_\'+chartid" class="gc-chart"></div>\n\n          \x3c!-- product selector --\x3e\n          <div class="field product-selector is-hidden" style="position: absolute; right: 0rem; top: -1.4rem;">\n          \x3c!--div class="field-label"><label class="label has-text-left is-grey" style="margin-bottom: 4px;">Product</label></div--\x3e\n            <div class="field-body has-text-bold">\n              <div class="select is-normal" v-if="mode!=\'many-indices\'">\n              <select v-model="selectedProduct" title="Choose a product!">\n                <option v-for="p in availableProducts" v-bind:value="p">\n                  <span v-if="p == \'vitality\'">{{capitalize(p)}}</span>\n                  <span v-else>{{p.toUpperCase()}}</span>\n                </option>\n                </select>\n              </div>\n              \x3c!-- div class="select is-normal is-multiple" v-else>\n                <select multiple size="2" v-model="availableProducts" title="Choose products!">\n                <option v-for="p in availableProducts" v-bind:value="p">\n                  <span v-if="p == \'vitality\'">{{capitalize(p)}}</span>\n                  <span v-else>{{p.toUpperCase()}}</span>\n                </option>\n                </select>\n              </div--\x3e\n            </div>\n          </div> \x3c!-- product selector --\x3e\n\n          </div>\n          \x3c!-- watermark --\x3e\n          <div class="is-inline-block is-pulled-right" style="opacity: 0.65; position: relative; bottom: 2.1rem; margin-right: 0.1rem;">\n            <span style="verticalalign: top; font-size: 0.7rem;">powered by</span><br>\n            <img src="img/logo.png" alt="geo|cledian" style="width: 100px; margin: -10px 0;">\n          </div>\n\n          </div>\n          \x3c!-- chart --\x3e',data:function(){return{chart:void 0,statistics:[],statisticsMany:[],selectedSource:"",internalSelectedProduct:"",parcels:[],currentRasterIndex:0,apiKey:this.gcApikey,apiHost:this.gcHost,apiUrl:"https://"+this.gcHost+"/agknow/api/v3",offset:0,pagingStep:1e3,total_parcel_count:250,chartLegendVisible:!0,similarity:{content_parcel:[],content_reference:[],similarity:{},summary:{},classification:{}},phenology:{phenology:{statistics:{},growth:{},markers:[]},summary:{}},currentGraphContent:"statistics",selectedGraphType:"line",selectedMarkerType:"phenology",sn_markers:{},selectedDate:"",hidden_graphs:[],internalZoomStartdate:new Date((new Date).getUTCFullYear()-1,2,1),internalZoomEnddate:new Date((new Date).getUTCFullYear()-1,10,1),inpFilterDateFromPicker:void 0,inpFilterDateToPicker:void 0}},computed:{currentParcelID:{get:function(){return this.gcParcelId},set:function(newValue){this.$root.$emit("selectedParcelIdChange",newValue)}},availableProducts:{get:function(){return this.products.split(",")},set:function(newValue){this.products=newValue}},selectedParcelIds:{get:function(){return"many-parcels"==this.mode?0==this.parcelIds.length?"true"==this.initialLoading?this.parcels.map(p=>parseInt(p.parcel_id)).slice(0,10):[]:this.parcelIds.split(",").length<=10?this.parcelIds.split(",").map(p=>parseInt(p)):[]:0==this.parcelIds.length?this.parcels.map(p=>parseInt(p.parcel_id)).slice(0,10):this.parcelIds.split(",").map(p=>parseInt(p)).slice(0,10)},set:function(newValue){this.parcelIds=newValue}},chartWidth:function(){return console.debug("clientwidth "+document.getElementById(this.chartid).clientWidth),console.debug("offsetwidth "+document.getElementById(this.chartid).offsetWidth),parseInt(document.getElementById(this.chartid).offsetWidth)},chartHeight:function(){return console.debug("clientheight "+document.getElementById(this.chartid).clientHeight),console.debug("offsetheight "+document.getElementById(this.chartid).offsetHeight),parseInt(document.getElementById(this.chartid).style.height)},filterString:{get:function(){return this.gcFilterString},set:function(newValue){this.$root.$emit("filterChange",newValue)}},chartFromDate:{get:function(){return this.isDateValid(this.gcZoomStartdate)?this.gcZoomStartdate:this.isDateValid(this.internalZoomStartdate)?this.internalZoomStartdate:void 0},set:function(newValue){this.isDateValid(newValue)&&(this.internalZoomStartdate=newValue,this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate]))}},chartToDate:{get:function(){return this.isDateValid(this.gcZoomEnddate)?this.gcZoomEnddate:this.isDateValid(this.internalZoomEnddate)?this.internalZoomEnddate:void 0},set:function(newValue){this.isDateValid(newValue)&&(this.internalZoomEnddate=newValue,this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate]))}},selectedProduct:{get:function(){return["sos","eos","pos"].includes(this.gcSelectedProduct)&&this.availableProducts.includes("vitality")?"vitality":this.gcSelectedProduct.length>0?this.gcSelectedProduct:this.internalSelectedProduct},set:function(newValue){this.internalSelectedProduct=newValue,this.$root.$emit("selectedProductChange",newValue)}},parcelIds:{get:function(){return this.gcParcelIds},set:function(newValue){this.$root.$emit("parcelIdsChange",newValue)}}},created:function(){},mounted:function(){document.getElementById("chart_"+this.chartid).classList.add("is-hidden"),document.getElementById("chartSpinner_"+this.chartid).classList.remove("is-hidden"),"many-indices"==this.mode&&(this.statisticsMany={vitality:[],ndvi:[],ndre1:[],ndre2:[],ndwi:[],savi:[],evi2:[],cire:[],npcri:[]}),"many-parcels"==this.mode&&(this.statisticsMany=[]),"one-index"!=this.mode&&"many-parcels"!=this.mode||(this.selectedProduct=this.availableProducts[0]),this.chart=c3.generate({bindto:"#chart_"+this.chartid,size:{width:this.chartWidth,height:this.chartHeight},data:{x:"x",columns:[]},grid:{x:{show:!0},y:{show:!0}},axis:{x:{type:"timeseries",tick:{fit:!1,format:"%e %b %y"}},y:{label:{text:"",position:"outer-top"}}}}),this.currentParcelID>0?this.getAllParcels(this.currentParcelID,this.offset,this.filterString):this.getAllParcels(void 0,this.offset,this.filterString),this.loadJSscript("css/bulma-ext/bulma-calendar.min.js",function(){this.inpFilterDateFromPicker=new bulmaCalendar(document.getElementById("inpFilterDateFrom_"+this.chartid),{startDate:new Date(this.internalZoomStartdate),dateFormat:"yyyy-mm-dd",lang:"en",overlay:!1,closeOnOverlayClick:!0,closeOnSelect:!0,onSelect:function(e){var a=new Date(e.valueOf()+864e5);this.internalZoomStartdate=a.toISOString().split("T")[0]}.bind(this)}),this.inpFilterDateToPicker=new bulmaCalendar(document.getElementById("inpFilterDateTo_"+this.chartid),{startDate:new Date(this.internalZoomEnddate),dateFormat:"yyyy-mm-dd",lang:"en",overlay:!1,closeOnOverlayClick:!0,closeOnSelect:!0,onSelect:function(e){var a=new Date(e.valueOf()+864e5);this.internalZoomEnddate=a.toISOString().split("T")[0]}.bind(this)})}.bind(this))},watch:{chartFromDate:function(newValue,oldValue){console.debug("event - chartFromDateChange"),this.isDateValid(newValue)&&new Date(newValue).getTime()<new Date(this.chartToDate).getTime()&&this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate])},chartToDate:function(newValue,oldValue){console.debug("event - chartToDateChange"),this.isDateValid(newValue)&&new Date(newValue).getTime()>new Date(this.chartFromDate).getTime()&&this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate])},selectedProduct:function(newValue,oldValue){if(newValue!=oldValue&&(console.debug("event - selectedProductChange"),this.parcels.length>0&&("one-index"==this.mode&&(this.getParcelsProductData(this.getCurrentParcel().parcel_id,this.selectedProduct,this.selectedSource),"visible"!=newValue&&(document.getElementById("chkChartHideMarker_"+this.chartid).checked?getMarkers(this.getCurrentParcel().parcel_id):this.sn_markers={},this.getIndexStats(this.getCurrentParcel().parcel_id,this.selectedSource,this.selectedProduct))),"many-parcels"==this.mode))){console.debug(this.selectedParcelIds);for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i];"visible"!=newValue&&this.getIndexStats(parcel_id,this.selectedSource,this.selectedProduct)}}},availableProducts:function(newValue,oldValue){if(console.debug("event - availableProductsChange"),this.parcels.length>0){if("one-index"==this.mode&&this.getIndexStats(this.getCurrentParcel().parcel_id,this.selectedSource,this.selectedProduct),"many-parcels"==this.mode)for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i];this.getParcelsProductData(parcel_id,this.selectedProduct,this.selectedSource),"visible"!=newValue&&this.getIndexStats(this.selectedParcelIds[i],this.selectedSource,this.selectedProduct)}if("many-indices"==this.mode)for(var i=0;i<this.availableProducts.length;i++)this.getParcelsProductData(this.getCurrentParcel().parcel_id,this.availableProducts[i],this.selectedSource),"visible"!=newValue&&this.getIndexStats(this.getCurrentParcel().parcel_id,this.selectedSource,this.availableProducts[i])}},selectedSource:function(newValue,oldValue){let p;console.debug("event - selectedSourceChange"),this.getCurrentParcel().timeSeries=[],this.currentParcelID>0&&(this.getParcelsProductData(this.getCurrentParcel().parcel_id,this.selectedProduct,this.selectedSource),this.currentRasterIndex=0)},currentParcelID:function(newValue,oldValue){console.debug("event - currentParcelIDChange"),"one-index"!=this.mode&&"many-indices"!=this.mode||this.handleCurrentParcelIDchange(newValue,oldValue)},parcelIds:function(newValue,oldValue){if(console.debug("event - parcelIdsChange"),this.parcelIds.length>0){if("many-parcels"==this.mode)for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i];parcel_id&&this.getIndexStats(parcel_id,this.selectedSource,this.selectedProduct)}}else this.chart.unload()},currentRasterIndex:function(newValue,oldValue){newValue!=oldValue&&console.debug("event - currentRasterIndexChange")},statistics:function(newValue,oldValue){console.debug("event - statisticsChange"),this.createChartData(),this.isDateValid(this.gcZoomStartdate)||(this.chartFromDate=newValue[0].date),this.isDateValid(this.gcZoomEnddate)||(this.chartToDate=newValue[newValue.length-1].date),this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate])},statisticsMany:{handler:function(newValue,oldValue){console.debug("event - statisticsManyChange"),this.createChartData(),"many-indices"==this.mode&&newValue[this.availableProducts[0]][0]&&(this.isDateValid(this.gcZoomStartdate)||(this.chartFromDate=newValue[this.availableProducts[0]][0].date),this.isDateValid(this.gcZoomEnddate)||(this.chartToDate=newValue[this.availableProducts[0]][newValue[this.availableProducts[0]].length-1].date)),this.isDateValid(this.chartFromDate)&&this.isDateValid(this.chartToDate)&&this.chart.zoom([this.chartFromDate,this.chartToDate])},deep:!0},hidden_graphs:function(newValue,oldValue){newValue!=oldValue&&(this.chart.show(),this.hidden_graphs.includes("mean")?(this.hidden_graphs.push("means2"),this.hidden_graphs.push("meanl8")):(this.hidden_graphs=this.removeFromArray(this.hidden_graphs,"means2"),this.hidden_graphs=this.removeFromArray(this.hidden_graphs,"meanl8")),this.chart.hide(this.hidden_graphs))},selectedGraphType:function(newValue,oldValue){if(newValue!=oldValue&&(console.debug("event - selectedGraphTypeChange"),console.debug("graph type changed!"),console.debug(newValue),"one-index"==this.mode&&(this.chart.transform(newValue,"mean"),this.chart.transform(newValue,"min"),this.chart.transform(newValue,"max"),this.chart.transform(newValue,"parcel (mean)"),this.chart.transform(newValue,"reference (mean)")),"many-indices"==this.mode&&(this.chart.transform(newValue,"ndvi"),this.chart.transform(newValue,"ndwi"),this.chart.transform(newValue,"ndre1"),this.chart.transform(newValue,"ndre2"),this.chart.transform(newValue,"savi"),this.chart.transform(newValue,"evi"),this.chart.transform(newValue,"cire"),this.chart.transform(newValue,"npcri"),this.chart.transform(newValue,"vitality")),"many-parcels"==this.mode))for(var i=0;i<this.selectedParcelIds.length;i++)this.chart.transform(newValue,this.selectedParcelIds[i])},selectedMarkerType:function(newValue,oldValue){newValue!=oldValue&&(console.debug("event - selectedMarkerTypeChange"),this.selectedMarkerType,this.createChartData())},gcSelectedParcelId:function(newValue,oldValue){this.chart.focus(parseInt(newValue))}},methods:{getAllParcels:function(parcel_id,offset,filterString){let limit=this.pagingStep,params="/parcels?key="+this.apiKey+"&limit="+limit;offset&&(params=params+"&offset="+offset),filterString&&(params+=filterString);let xmlHttp=new XMLHttpRequest,async=!0;console.debug("getAllParcels()"),console.debug("GET "+this.apiUrl+params),xmlHttp.onreadystatechange=function(){if(4==xmlHttp.readyState){var tmp=JSON.parse(xmlHttp.responseText);if("key is not authorized"==tmp.content)return document.getElementById("chartNotice_"+this.chartid).innerHTML="Sorry, the given API key is not authorized!<br> Please contact <a href='https://www.geocledian.com'>geo|cledian</a> for a valid API key.",document.getElementById("chartNotice_"+this.chartid).classList.remove("is-hidden"),void document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden");if("api key validity expired"==tmp.content)return document.getElementById("chartNotice_"+this.chartid).innerHTML="Sorry, the given API key's validity expired!<br> Please contact <a href='https://www.geocledian.com'>geo|cledian</a>for a valid API key.",document.getElementById("chartNotice_"+this.chartid).classList.remove("is-hidden"),void document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden");if(this.parcels=[],0==tmp.content.length)return;for(var i=0;i<tmp.content.length;i++){var item=tmp.content[i];this.parcels.push(item)}try{"one-index"==this.mode||"many-indices"==this.mode?parcel_id?(this.currentParcelID=parcel_id,console.debug("setting "+parcel_id+" parcel id as current!"),this.handleCurrentParcelIDchange(-1,this.currentParcelID)):(console.debug("setting first parcel as current!"),this.currentParcelID=this.parcels[0].parcel_id,this.currentParcelID==this.parcels[0].parcel_id&&this.handleCurrentParcelIDchange(-1,this.parcels[0].parcel_id),console.debug("currentParcelID: "+this.currentParcelID)):this.handleCurrentParcelIDchange()}catch(err){console.debug("error selecting parcel_id"),console.debug(err)}}}.bind(this),xmlHttp.open("GET",this.apiUrl+params,!0),xmlHttp.send()},handleCurrentParcelIDchange:function(){if(console.debug("methods - handleCurrentParcelIDchange"),this.currentParcelID>0&&("sn_marker"==this.selectedMarkerType?this.getMarkers(this.getCurrentParcel().parcel_id):this.sn_markers={},"one-index"==this.mode&&this.getIndexStats(this.getCurrentParcel().parcel_id,this.selectedSource,this.selectedProduct),"many-indices"==this.mode))for(var i=0;i<this.availableProducts.length;i++)this.getIndexStats(this.getCurrentParcel().parcel_id,this.selectedSource,this.availableProducts[i]);if("many-parcels"==this.mode)for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i];parcel_id&&this.getIndexStats(parcel_id,this.selectedSource,this.selectedProduct)}},getParcelsProductData:function(parcel_id,productName,source){document.getElementById("chartSpinner_"+this.chartid).classList.remove("is-hidden");let params="/parcels/"+parcel_id+"/"+productName+"?key="+this.apiKey+"&source="+source+"&order=date",xmlHttp=new XMLHttpRequest,async=!0;console.debug("getParcelsProductData()"),console.debug("GET "+this.apiUrl+params),xmlHttp.onreadystatechange=function(){if(4==xmlHttp.readyState){let tmp=JSON.parse(xmlHttp.responseText),row=this.getCurrentParcel();tmp.content.length>0&&(Vue.set(row,"timeSeries",tmp.content),document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden"))}}.bind(this),xmlHttp.open("GET",this.apiUrl+params,!0),xmlHttp.send()},getCurrentParcel:function(){if(this.currentParcelID>0)return this.parcels.filter(p=>p.parcel_id+""==this.currentParcelID+"")[0]},getParcel:function(parcel_id){if(parcel_id>0)return this.parcels.filter(p=>p.parcel_id+""==parcel_id+"")[0]},getIndexStats:function(parcel_id,source,product){document.getElementById("chartNotice_"+this.chartid).classList.add("is-hidden"),document.getElementById(this.chartid).getElementsByClassName("product-selector")[0].classList.add("is-hidden"),document.getElementById("chart_"+this.chartid).classList.add("is-hidden"),document.getElementById("chartSpinner_"+this.chartid).classList.remove("is-hidden");let productName=product;"visible"==productName&&(productName="vitality");var params="/parcels/"+parcel_id+"/"+productName+"?key="+this.apiKey+"&source="+source+"&order=date&statistics=true",xmlHttp=new XMLHttpRequest,async=!0;console.debug("getIndexStats()"),console.debug("GET "+this.apiUrl+params),this.chart.unload(),xmlHttp.onreadystatechange=function(){if(4==xmlHttp.readyState){var tmp=JSON.parse(xmlHttp.responseText),row=this.getParcel(parcel_id);if(tmp.content.length>0){if(this.currentGraphContent="statistics","one-index"==this.mode&&(this.statistics=tmp.content),"many-parcels"==this.mode){let parcel=this.statisticsMany.find(p=>parseInt(p.parcel_id)==parseInt(parcel_id));if(parcel){let idx=this.statisticsMany.indexOf(parcel);parcel[productName]=tmp.content,this.statisticsMany.splice(idx,1,parcel)}else parcel={parcel_id:parseInt(parcel_id)},parcel[productName]=tmp.content,this.statisticsMany.push(parcel);console.debug(this.statisticsMany)}"many-indices"==this.mode&&(this.statisticsMany[productName]=tmp.content)}}}.bind(this),xmlHttp.open("GET",this.apiUrl+params,!0),xmlHttp.send()},createChartData:function(){console.debug("createChartData()"),console.debug(this.currentGraphContent),console.debug(this.mode);let chartType=this.currentGraphContent,columns=[];if("statistics"==chartType){if("one-index"==this.mode&&this.statistics.length>0){let filteredStats=this.statistics.filter(s=>null!=s.statistics);columns[0]=["x"].concat(filteredStats.map(r=>r.date)),columns[1]=["mean"].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.mean,3))),columns[2]=["std.dev."].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.stddev,3))),columns[3]=["min"].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.min,3))),columns[4]=["max"].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.max,3))),columns[5]=["meanl8"].concat(filteredStats.map(function(r){return"landsat8"===r.source?this.formatDecimal(r.statistics.mean,3):null}.bind(this))),columns[6]=["means2"].concat(filteredStats.map(function(r){return"sentinel2"===r.source?this.formatDecimal(r.statistics.mean,3):null}.bind(this)))}if("many-indices"==this.mode){columns[0]=["x"].concat(this.statisticsMany[this.availableProducts[0]].map(r=>r.date)),console.debug("first x axis is "+this.availableProducts[0]),this.availableProducts.includes("vitality")&&(columns[1]=["x3"].concat(this.statisticsMany.vitality.filter(s=>null!=s.statistics).map(r=>r.date)));for(var i=0;i<this.availableProducts.length;i++){let product=this.availableProducts[i],filteredStats=this.statisticsMany[product].filter(s=>null!=s.statistics);columns[columns.length]=[product].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.mean,3)))}}if("many-parcels"==this.mode&&this.statisticsMany.length>0){for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i],idx=this.selectedParcelIds.indexOf(parcel_id),parcel=this.statisticsMany.find(p=>p.parcel_id==parcel_id);if(parcel){let parcelStats=parcel[this.selectedProduct];if(parcelStats){let filteredStats=parcelStats.filter(s=>null!=s.statistics);columns[idx]=["x"+idx].concat(filteredStats.map(r=>r.date))}}}for(var i=0;i<this.selectedParcelIds.length;i++){let parcel_id=this.selectedParcelIds[i],parcel=this.statisticsMany.find(p=>p.parcel_id==parcel_id);if(parcel){let parcelStats=parcel[this.selectedProduct];if(parcelStats){let filteredStats=parcelStats.filter(s=>null!=s.statistics);columns[columns.length]=[parcel_id].concat(filteredStats.map(r=>this.formatDecimal(r.statistics.mean,3)))}}}}try{let markers;if("sn_marker"==this.selectedMarkerType&&this.sn_markers&&(markers=this.sn_markers.markers),"phenology"==this.selectedMarkerType&&this.phenology.phenology&&(markers=this.phenology.phenology.markers),markers&&(markers.sort((a,b)=>a.date>b.date?1:-1),markers.length>0)){let dates_markers=markers.map(r=>"None"!=r.date?r.date:NaN);columns[7]=["x2"].concat(dates_markers),columns[8]=["marker"].concat(markers.map(r=>this.formatDecimal(r.mean,3)))}}catch(err){console.log("error getting markers!"),console.error(err)}document.getElementById("chartNotice_"+this.chartid).classList.add("is-hidden"),"many-parcels"==this.mode?columns.length==2*this.selectedParcelIds.length?(this.createChart(columns),document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden"),document.getElementById("chart_"+this.chartid).classList.remove("is-hidden")):console.debug("createChartData() - not ready yet: not all statistics processed!"):(this.createChart(columns),document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden"),document.getElementById("chart_"+this.chartid).classList.remove("is-hidden"))}if("similarity"==chartType&&this.similarity.content_parcel.length>0){let columns=[];this.createChart(columns),document.getElementById("chartSpinner_"+this.chartid).classList.add("is-hidden"),document.getElementById("chart_"+this.chartid).classList.remove("is-hidden")}},createChart:function(data){console.debug("createChart()");let xs_options={},types_options={mean:this.selectedGraphType,"std.dev.":"bar",min:this.selectedGraphType,max:this.selectedGraphType,meanl8:"scatter",means2:"scatter","parcel (mean)":this.selectedGraphType,"reference (mean)":this.selectedGraphType,marker:"scatter"};if("one-index"==this.mode&&(xs_options={mean:"x",means2:"x",meanl8:"x",min:"x",max:"x","std.dev.":"x","parcel (mean)":"x2","reference (mean)":"x2",marker:"x2"}),"many-indices"==this.mode){for(var i=0;i<this.availableProducts.length;i++){const product=this.availableProducts[i];xs_options[product]="vitality"!=product?"x":"x3"}xs_options["parcel (mean)"]="x",xs_options["reference (mean)"]="x2"}if("many-parcels"==this.mode)for(var i=0;i<this.selectedParcelIds.length;i++){const parcel_id=this.selectedParcelIds[i],idx=this.selectedParcelIds.indexOf(parcel_id);xs_options[parcel_id]="x"+idx,types_options[parcel_id]=this.selectedGraphType}var axis_label;axis_label="one-index"==this.mode?"vitality"==this.selectedProduct||"variations"==this.selectedProduct||"visible"==this.selectedProduct?"NDVI":this.selectedProduct.toUpperCase():"Index [mean]",console.debug("data: "),console.debug(data),console.debug("xs: "),console.debug(xs_options),this.chart=c3.generate({bindto:"#chart_"+this.chartid,size:{width:this.chartWidth,height:this.chartHeight},data:{selection:{enabled:!0,isselectable:function(d){return"marker"!=d.id&&"reference (mean)"!=d.id&&"parcel (mean)"!=d.id},multiple:!1,grouped:!1},xs:xs_options,columns:data,names:{meanl8:"landsat8",means2:"sentinel2"},hide:this.hidden_graphs,type:"line",types:types_options,colors:{mean:"#EF7D00","std.dev.":" #d6d6d6",min:"#EF7D00",max:"#EF7D00",meanl8:"#0500ef",means2:"#00eaef","parcel (mean)":"#EF7D00","reference (mean)":"#1f77b4",marker:"grey"},color:function(color,d){if("marker"==d.id){let c;return"sn_marker"==this.selectedMarkerType&&(c=this.sn_markers.markers[d.index].status),"phenology"==this.selectedMarkerType&&(c=this.phenology.phenology.markers[d.index].status),c}return color},onselected:function(e,svgElement){console.debug("onselectedChange()"),"statistics"==this.currentGraphContent&&(this.selectedDate=e.x.simpleDate(),this.$root.$emit("queryDateChange",this.selectedDate))}.bind(this)},spline:{interpolation:{type:"monotone"}},legend:{item:{onclick:function(id){"mean"==id?(this.chart.toggle("mean"),this.chart.toggle("meanl8"),this.chart.toggle("means2")):this.chart.toggle(id)}.bind(this)}},line:{connectNull:!0},point:{show:!0,focus:{expand:{r:6}},r:function(d){return"marker"==d.id?6:3}},transition:{duration:300},grid:{x:{show:!0},y:{show:!0}},axis:{x:{type:"timeseries",tick:{fit:!1,format:"%e %b %y"}},y:{label:{text:axis_label,position:"outer-top"},padding:{top:10,bottom:0}}},zoom:{enabled:!0},tooltip:{grouped:!0,format:{value:function(value,ratio,id,index){if("meanl8"!=id&&"means2"!=id)return"statistics"!=this.currentGraphContent?value:""!=this.selectedSource?value:"marker"==id?value:"one-index"==this.mode?value+" ("+this.statistics[index].source+")":"many-indices"==this.mode?value+" ("+this.statisticsMany[id][index].source+")":"many-parcels"==this.mode?value+" ("+this.statisticsMany.find(p=>p.parcel_id==id)[this.selectedProduct][index].source+")":void 0}.bind(this)},contents:function(d,defaultTitleFormat,defaultValueFormat,color){var $$=this,config=$$.config,titleFormat=config.tooltip_format_title||defaultTitleFormat,nameFormat=config.tooltip_format_name||function(name){return name},valueFormat=config.tooltip_format_value||defaultValueFormat,text,i,title,value,name,bgcolor;for(i=0;i<d.length;i++)if(d[i]&&(d[i].value||0===d[i].value)&&(text||(title=titleFormat?titleFormat(d[i].x):d[i].x,text="<table class='"+$$.CLASS.tooltip+"'>"+(title||0===title?"<tr><th colspan='2'>"+title+"</th></tr>":"")),"meanl8"!=d[i].id&&"means2"!=d[i].id)){if("marker"==d[i].id){let index=d[i].index,markers;"sn_marker"==this.selectedMarkerType&&(markers=this.sn_markers.markers),"phenology"==this.selectedMarkerType&&(markers=this.phenology.phenology.markers),name=nameFormat(markers[index].name),value=valueFormat(this.formatDecimal(d[i].value,3),d[i].ratio,d[i].id,d[i].index),bgcolor=markers[index].status}else name=nameFormat(d[i].name),value=valueFormat(d[i].value,d[i].ratio,d[i].id,d[i].index),bgcolor=$$.levelColor?$$.levelColor(d[i].value):color(d[i].id);text+="<tr class='"+$$.CLASS.tooltipName+"-"+d[i].id+"'>",text+="<td class='name'><span style='background-color:"+bgcolor+"'></span>"+name+"</td>",text+="<td class='value'>"+value+"</td>",text+="</tr>"}return text+"</table>"}}}),document.getElementById(this.chartid).getElementsByClassName("product-selector")[0].classList.remove("is-hidden")},toggleChartOptions:function(){let isGraphOptionsActive=!1;isGraphOptionsActive=!document.getElementById("chartOptions_"+this.chartid).classList.contains("is-hidden"),isGraphOptionsActive?(document.getElementById("chartOptions_"+this.chartid).classList.add("is-hidden"),document.getElementById(this.chartid).getElementsByClassName("chartOptionsTitle")[0].children[0].classList.remove("is-active")):(document.getElementById("chartOptions_"+this.chartid).classList.remove("is-hidden"),document.getElementById(this.chartid).getElementsByClassName("chartOptionsTitle")[0].children[0].classList.add("is-active"))},removeFromArray:function(arry,value){let index=arry.indexOf(value);return index>-1&&arry.splice(index,1),arry},formatDecimal:function(decimal,numberOfDecimals){var factor=100;return isNaN(parseFloat(decimal))?NaN:(1==numberOfDecimals&&(factor=10),2==numberOfDecimals&&(factor=100),3==numberOfDecimals&&(factor=1e3),4==numberOfDecimals&&(factor=1e4),5==numberOfDecimals&&(factor=1e5),Math.ceil(decimal*factor)/factor)},capitalize:function(s){return"string"!=typeof s?"":s.charAt(0).toUpperCase()+s.slice(1)},isDateValid:function(date_str){return!isNaN(new Date(date_str))},loadJSscript:function(url,callback){let script=document.createElement("script");script.src=url,script.async=!0,document.body.appendChild(script),script.onload=function(){callback()}}}});